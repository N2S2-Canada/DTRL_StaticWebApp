<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Switching account…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <style>
        :root {
            color-scheme: light dark;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            display: grid;
            place-items: center;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
        }

        .box {
            padding: 2rem;
            border-radius: 18px;
            background: rgba(0,0,0,.05);
            max-width: 720px;
        }

        h1 {
            margin: 0 0 .5rem;
            font-size: clamp(1.2rem, 3vw, 1.6rem);
        }

        p {
            margin: .25rem 0;
            opacity: .85;
        }
    </style>
</head>
<body>
    <div class="box">
        <h1>Switching account…</h1>
        <p>If this takes more than a few seconds, <a id="again" href="#">click here</a>.</p>
    </div>

    <script>
  (function () {
    const params = new URLSearchParams(location.search);
    let step = params.get("s") || "0";
    let returnTo = params.get("r") || "/admin/cms";

    // Prefer the admin referrer if present
    try {
      const ref = document.referrer ? new URL(document.referrer) : null;
      if (!params.has("r") && ref && ref.origin === location.origin && ref.pathname.startsWith("/admin/")) {
        returnTo = ref.pathname + ref.search + ref.hash;
      }
    } catch (_){}

    // Avoid loops
    if (returnTo === "/login" || returnTo === "/not-authorized.html" || returnTo === "/switch-account.html")
      returnTo = "/admin/cms";

    const origin = location.origin;

    // Build the 3-step chain:
    // s=0 -> SWA logout -> /switch-account?s=1&r=...
    const afterSwaLogout = origin + "/switch-account.html?s=1&r=" + encodeURIComponent(returnTo);
    const swaLogout = origin + "/.auth/logout?post_logout_redirect_uri=" + encodeURIComponent(afterSwaLogout);

    // s=1 -> Microsoft logout -> /switch-account?s=2&r=...
    const afterMsLogout = origin + "/switch-account.html?s=2&r=" + encodeURIComponent(returnTo);
    const msLogout = "https://login.microsoftonline.com/common/oauth2/v2.0/logout?post_logout_redirect_uri=" + encodeURIComponent(afterMsLogout);

    // s=2 -> SWA login with account picker -> returnTo
    const swaLogin = origin + "/.auth/login/aad?prompt=select_account&post_login_redirect_uri=" + encodeURIComponent(returnTo);

    const go = url => location.replace(url);

    switch (step) {
      case "0": go(swaLogout); break;
      case "1": go(msLogout); break;
      default:  go(swaLogin); break; // s=2 (or anything else) -> login
    }

    document.getElementById("again").href = (step === "0" ? swaLogout : step === "1" ? msLogout : swaLogin);
  })();
    </script>
</body>
</html>

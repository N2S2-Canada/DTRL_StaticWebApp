<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Not authorized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <style>
        :root {
            color-scheme: light dark;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
        }

        .wrap {
            min-height: 100%;
            display: grid;
            place-items: center;
            padding: 2rem;
        }

        .card {
            max-width: 760px;
            width: 100%;
            border-radius: 18px;
            padding: 2rem;
            background: rgba(0,0,0,.04);
        }

        h1 {
            margin: 0 0 .5rem;
            font-size: clamp(1.6rem, 3vw, 2rem);
        }

        p {
            margin: .25rem 0 .8rem;
            line-height: 1.5;
        }

        code {
            padding: .15rem .35rem;
            border-radius: .4rem;
            background: rgba(0,0,0,.08);
        }

        .hint {
            opacity: .85;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            margin-top: 1rem;
        }

        a.button {
            text-decoration: none;
            padding: .6rem 1rem;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,.2);
            display: inline-block;
        }

        a.primary {
            border-color: transparent;
            background: #2563eb;
            color: #fff;
        }

        .who {
            margin-top: .75rem;
            font-size: .95rem;
            opacity: .9;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <h1>Not authorized</h1>
            <p>You’re signed in, but your account doesn’t have access to this page.</p>
            <p class="hint">
                If you believe this is a mistake, contact the site owner and ask to be added to the
                <code>admin</code> role for this domain.
            </p>

            <div class="actions">
                <!-- Will be set dynamically to return to the page you came from -->
                <a id="signin" class="button primary" href="/.auth/login/aad">Sign in</a>
                <a id="signin-diff" class="button" href="#">Sign in as a different user</a>
                <a id="signout" class="button" href="/.auth/logout">Sign out</a>
                <a class="button" href="/">Go to home</a>
            </div>

            <div id="who" class="who" hidden></div>
        </div>
    </div>

    <script>
        (async function () {
            // Decide where to return after login: prefer the admin page that led here.
            let returnTo = "/";
            try {
                const ref = document.referrer ? new URL(document.referrer) : null;
                if (ref && ref.origin === location.origin && ref.pathname.startsWith("/admin/")) {
                    returnTo = ref.pathname + ref.search + ref.hash;
                }
            } catch (_) { }

            // Never loop to this page
            if (returnTo === "/not-authorized.html") returnTo = "/admin/cms";

            // Build URLs
            // Build URLs
            const loginUrl = "/.auth/login/aad?post_login_redirect_uri=" + encodeURIComponent(returnTo);
            // Force credential entry (prevents silent reuse of the wrong account)
            const loginForce = "/.auth/login/aad?prompt=login&post_login_redirect_uri=" + encodeURIComponent(returnTo);
            const logoutToHome = "/.auth/logout?post_logout_redirect_uri=/";
            // Log out of SWA, then immediately send to AAD with prompt=login
            const logoutThenLoginForce = "/.auth/logout?post_logout_redirect_uri=" + encodeURIComponent(loginForce);

            // Wire buttons
            document.getElementById("signin").setAttribute("href", loginUrl);
            const switchUrl = "/switch-account.html?r=" + encodeURIComponent(returnTo);
            document.getElementById("signin-diff").setAttribute("href", switchUrl);
            document.getElementById("signout").setAttribute("href", logoutToHome);

            // Show current identity
            try {
                const r = await fetch("/.auth/me", { credentials: "include" });
                if (r.ok) {
                    const j = await r.json();
                    const u = j && (j.clientPrincipal || j.ClientPrincipal);
                    if (u) {
                        const roles = (u.userRoles || u.UserRoles || []).join(", ");
                        const who = document.getElementById("who");
                        who.hidden = false;
                        who.textContent = `Signed in as: ${u.userDetails || "unknown"} — Roles: ${roles || "none"}`;
                    }
                }
            } catch { } // noop
        })();
    </script>
</body>
</html>

@page "/videos"
@inject HttpClient Http
@inject IJSRuntime JS

<!-- Particle background canvas -->
<canvas id="particleCanvas"></canvas>
<!-- Main content -->
<h1>DiverseTech Robotics Media</h1>

@if (videos == null)
{
    <p>Loading...</p>
}
else if (videos.Count == 0)
{
    <p>No media found.</p>
}
else
{
    @foreach (var group in videos
                            .Where(v => v.Categories.Any())
                            .GroupBy(v => v.Categories.First())
                            .OrderBy(g => g.Key))
    {
        <h4 class="mt-4">@group.Key</h4>
        <div class="row g-3">
            @foreach (var item in group)
            {
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100 shadow-sm card-hover-lift">
                        @if (item.IsVideo)
                        {
                            <div class="video-thumbnail-wrapper" @onclick="() => ShowModalAsync(item.Url!, true)">
                                <img src="@item.ThumbnailUrl" class="card-img-top media-photo" alt="@item.Name" />
                                <span class="play-icon">&#9658;</span>
                            </div>
                        }
                        else
                        {
                            <img src="@item.Url" class="card-img-top media-photo" alt="@item.Name"
                                 @onclick="() => ShowModalAsync(item.Url!)" />
                        }

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-2">@item.Name</h5>
                            <div class="mb-2">
                                @foreach (var category in item.Categories)
                                {
                                    <span class="badge @GetCategoryClasses(category) border border-dark rounded-pill me-1 category-badge">@category</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}

<!-- Bootstrap Modal -->
<div class="modal fade" tabindex="-1" id="mediaModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" @onclick="CloseModalAsync" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                @if (modalIsVideo)
                {
                    <video controls autoplay class="img-fluid">
                        <source src="@modalVideoUrl" type="video/mp4" />
                        Your browser does not support the video tag.
                    </video>
                }
                else
                {
                    <img src="@modalImageUrl" alt="Enlarged media" class="img-fluid" />
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<Video>? videos;

    private bool modalIsVideo = false;
    private string modalImageUrl = "";
    private string modalVideoUrl = "";
    private IJSObjectReference? module;

    protected override async Task OnInitializedAsync()
    {
        videos = await Http.GetFromJsonAsync<List<Video>>("/api/videos") ?? new List<Video>();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./scripts/mediaModal.js");
            var particleModule = await JS.InvokeAsync<IJSObjectReference>("import", "./scripts/particles.js");
            await particleModule.InvokeVoidAsync("startParticles");
        }
    }

    private async Task ShowModalAsync(string url, bool isVideo = false)
    {
        modalIsVideo = isVideo;

        if (isVideo)
        {
            modalVideoUrl = url;
            modalImageUrl = "";
        }
        else
        {
            modalImageUrl = url;
            modalVideoUrl = "";
        }

        if (module is not null)
        {
            await module.InvokeVoidAsync("show");
        }
    }

    private async Task CloseModalAsync()
    {
        if (module is not null)
        {
            await module.InvokeVoidAsync("hide");
        }

        modalImageUrl = "";
        modalVideoUrl = "";
        modalIsVideo = false;
    }

    // Bootstrap-based category style mappings (all unique)
    private readonly Dictionary<string, string> CategoryClasses = new()
{
    { "nature", "bg-primary text-white" },            // Blue
    { "agriculture", "bg-success text-dark" },        // Green
    { "industrial", "bg-warning text-dark" },         // Orange
    { "real estate", "bg-danger text-white" },        // Red
    { "wedding", "bg-info text-dark" },              // Light blue
    { "social", "bg-secondary text-white" },         // Grey
    { "mapping", "bg-success-subtle text-dark" },    // Very light green
    { "inspection", "bg-primary-subtle text-dark" }, // Very light blue
    { "videography", "bg-warning-subtle text-dark" },// Very light orange
    { "photography", "bg-info-subtle text-dark" },   // Very light blue
    { "multi-spectra", "bg-dark text-white" },       // Black / Dark grey
    { "event", "bg-danger-subtle text-dark" },       // Very light red
    { "community", "bg-light text-dark" }            // White / Light grey
};

    private string GetCategoryClasses(string category)
    {
        if (string.IsNullOrWhiteSpace(category))
            return "bg-secondary text-white";

        var key = category.Trim().ToLowerInvariant();
        return CategoryClasses.TryGetValue(key, out var css) ? css : "bg-secondary text-white";
    }
}
